<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS MIDI Mixer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header Bar -->
        <header class="header-bar">
            <div class="header-left">
                <h1 class="app-title">OBS MIDI Mixer</h1>
                <div class="connection-status">
                    <div class="status-indicator" id="obsStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">OBS: Verbindung...</span>
                    </div>
                    <div class="status-indicator" id="midiStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">MIDI: Suche...</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="connectBtn" title="Verbindungen pr√ºfen">üîó</button>
                <button class="header-btn" id="debugBtn" title="Debug-Info">üêõ</button>
                <button class="header-btn" id="settingsBtn" title="Einstellungen">‚öôÔ∏è</button>
                <button class="header-btn" id="minimizeBtn" title="Minimieren">‚àí</button>
                <button class="header-btn close" id="closeBtn" title="Schlie√üen">√ó</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Audio Section (Left) -->
            <section class="audio-section" id="audioSection">
                <div class="section-header">
                    <h2>Audio Quellen</h2>
                    <button class="refresh-btn" id="refreshAudio">üîÑ</button>
                </div>
                
                <div class="audio-sources" id="audioSources">
                    <!-- Audio sources will be dynamically loaded here -->
                    <div class="no-sources-message" id="noSourcesMessage">
                        <p>Keine Audio-Quellen gefunden</p>
                        <p class="help-text">Verbinde dich mit OBS und stelle sicher, dass Audio-Quellen vorhanden sind</p>
                        <p class="help-text">üîó Klicke auf "Verbindungen pr√ºfen" um OBS zu verbinden</p>
                    </div>
                </div>
            </section>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resizeHandle">
                <div class="resize-line"></div>
            </div>

            <!-- Hotkeys Section (Right) -->
            <section class="hotkeys-section" id="hotkeysSection">
                <div class="section-header">
                    <h2>MIDI Hotkeys</h2>
                    <div class="hotkey-buttons">
                        <button class="learn-btn" id="learnMidiBtn">MIDI Lernen</button>
                        <button class="test-btn" id="testBtn">üß™ Test</button>
                    </div>
                </div>
                
                <div class="hotkey-mappings" id="hotkeyMappings">
                    <div class="no-mappings-message" id="noMappingsMessage">
                        <p>Keine MIDI-Zuordnungen</p>
                        <p class="help-text">Dr√ºcke "MIDI Lernen" und bet√§tige dein MIDI-Ger√§t</p>
                        <p class="help-text">Oder ordne Audio-Quellen und Szenen direkt zu</p>
                        <p class="help-text">üéπ Launch Control XL: Aktiviere Low Power Mode f√ºr bessere Stabilit√§t</p>
                    </div>
                    
                    <!-- Scene mappings will be added here dynamically -->
                </div>
            </section>
        </main>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Einstellungen</h3>
                    <button class="modal-close" id="closeSettings">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="settings-group">
                        <label for="obsUrl">OBS WebSocket URL:</label>
                        <input type="text" id="obsUrl" placeholder="ws://localhost:4455">
                        <small class="help-text">Standard: ws://localhost:4455</small>
                    </div>
                    <div class="settings-group">
                        <label for="obsPassword">OBS Passwort:</label>
                        <input type="password" id="obsPassword" placeholder="Passwort (optional)">
                        <small class="help-text">Leer lassen wenn kein Passwort gesetzt</small>
                    </div>
                    <div class="settings-group">
                        <label for="midiDevice">MIDI Ger√§t:</label>
                        <select id="midiDevice">
                            <option value="">Automatisch erkennen</option>
                        </select>
                        <small class="help-text">Launch Control XL: Low Power Mode aktivieren f√ºr bessere Stabilit√§t</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="resetSettings">Zur√ºcksetzen</button>
                    <button class="btn-primary" id="saveSettings">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Connection Modal -->
        <div class="modal-overlay" id="connectionModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Verbindungsstatus</h3>
                    <button class="modal-close" id="closeConnection">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="connection-section">
                        <h4>üé• OBS Studio</h4>
                        <div class="connection-info" id="obsConnectionInfo">
                            <p>Status: <span id="obsConnectionStatus">Pr√ºfe...</span></p>
                            <p>URL: <span id="obsConnectionUrl">ws://localhost:4455</span></p>
                            <p>Versuche: <span id="obsReconnectAttempts">0</span></p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-primary" id="connectObs">OBS Verbinden</button>
                            <button class="btn-secondary" id="disconnectObs">Trennen</button>
                        </div>
                    </div>
                    
                    <div class="connection-section">
                        <h4>üéπ MIDI Controller</h4>
                        <div class="connection-info" id="midiConnectionInfo">
                            <p>Status: <span id="midiConnectionStatus">Pr√ºfe...</span></p>
                            <p>Ger√§t: <span id="midiDeviceName">Kein Ger√§t</span></p>
                            <p>Verf√ºgbare Ger√§te: <span id="midiDeviceCount">0</span></p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-primary" id="scanMidi">MIDI Scannen</button>
                            <button class="btn-secondary" id="disconnectMidi">Trennen</button>
                        </div>
                        
                        <!-- Launch Control XL Help -->
                        <div style="margin-top: 12px; padding: 12px; background: var(--tertiary-bg); border-radius: 6px; font-size: 12px;">
                            <strong>üéõÔ∏è Launch Control XL Hilfe:</strong><br>
                            <strong>Low Power Mode aktivieren:</strong><br>
                            1. Halte "User" + "Factory Template" Buttons<br>
                            2. USB-Kabel einstecken<br>
                            3. Buttons loslassen<br>
                            4. "Record Arm" dr√ºcken<br>
                            5. Rechten Pfeil-Button dr√ºcken<br>
                            <em>Verhindert automatisches Standby</em>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="refreshConnection">Aktualisieren</button>
                </div>
            </div>
        </div>

        <!-- Debug Modal -->
        <div class="modal-overlay" id="debugModal" style="display: none;">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>Debug-Information</h3>
                    <button class="modal-close" id="closeDebug">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="debug-section">
                        <h4>üìä App Status</h4>
                        <pre id="debugAppStatus">Lade...</pre>
                    </div>
                    <div class="debug-section">
                        <h4>üéπ MIDI Events (Live)</h4>
                        <div class="debug-log" id="midiEventLog">Keine Events...</div>
                        <button class="btn-secondary" id="clearMidiLog">Log l√∂schen</button>
                    </div>
                    <div class="debug-section">
                        <h4>üé• OBS Events (Live)</h4>
                        <div class="debug-log" id="obsEventLog">Keine Events...</div>
                        <button class="btn-secondary" id="clearObsLog">Log l√∂schen</button>
                    </div>
                    <div class="debug-section">
                        <h4>üîß Fehlerbehebung</h4>
                        <p style="font-size: 12px; color: var(--text-secondary);">
                            <strong>Audio-Pegel zu niedrig:</strong> Volume-Conversion wurde korrigiert<br>
                            <strong>MIDI-Ger√§t Standby:</strong> Low Power Mode aktivieren<br>
                            <strong>Dialog schlie√üt nicht:</strong> ESC-Taste oder erfolgreiche Zuordnung<br>
                            <strong>Sortierung:</strong> An ‚ãÆ‚ãÆ Symbol ziehen
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="exportDebug">Debug exportieren</button>
                    <button class="btn-primary" id="refreshDebug">Aktualisieren</button>
                </div>
            </div>
        </div>

        <!-- MIDI Learning Overlay -->
        <div class="midi-learning-overlay" id="midiLearningOverlay" style="display: none;">
            <div class="learning-content">
                <div class="learning-icon">üéπ</div>
                <h3>MIDI Learning Aktiv</h3>
                <p>Bewege einen Regler oder dr√ºcke einen Button auf deinem MIDI-Controller</p>
                <div class="learning-target" id="learningTarget"></div>
                <button class="btn-secondary" onclick="window.uiManager.stopMidiLearning()">Abbrechen (ESC)</button>
            </div>
        </div>
    </div>

    <!-- Scripts - Load in correct order for proper initialization -->
    <script>
        console.log('Starting module initialization...');
        
        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Global JavaScript Error:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled Promise Rejection:', event.reason);
        });

        // Check for required APIs
        console.log('üîç Checking Browser APIs...');
        console.log('Web MIDI API:', typeof navigator.requestMIDIAccess !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('WebSocket API:', typeof WebSocket !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('LocalStorage API:', typeof localStorage !== 'undefined' ? '‚úÖ' : '‚ùå');
    </script>
    
    <!-- SortableJS for Drag & Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        // Verify SortableJS loaded
        if (typeof Sortable !== 'undefined') {
            console.log('‚úÖ SortableJS loaded for drag & drop functionality');
        } else {
            console.warn('‚ùå SortableJS failed to load - drag & drop will be disabled');
        }
    </script>
    
    <!-- Load managers in dependency order -->
    <script src="../modules/settings-manager.js"></script>
    <script src="../modules/obs-websocket.js"></script>
    <script src="../modules/midi-controller.js"></script>
    <script src="../modules/audio-manager.js"></script>
    <script src="../modules/ui-manager.js"></script>
    
    <!-- Load main renderer -->
    <script src="renderer.js"></script>
    
    <script>
        // Module loading verification
        console.log('=== Module Loading Status ===');
        console.log('Settings Manager:', typeof window.settingsManager !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('OBS Manager:', typeof window.obsManager !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('MIDI Controller:', typeof window.midiController !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('Audio Manager:', typeof window.audioManager !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('UI Manager:', typeof window.uiManager !== 'undefined' ? '‚úÖ' : '‚ùå');
        
        // Advanced diagnostics
        console.log('\nüîç Advanced Diagnostics:');
        console.log('Sortable Library:', typeof Sortable !== 'undefined' ? `‚úÖ v${Sortable.version || 'unknown'}` : '‚ùå');
        console.log('Drag & Drop Ready:', typeof Sortable !== 'undefined' && document.readyState === 'complete' ? '‚úÖ' : '‚è≥');
        
        // Quick start helper
        console.log('\nüéõÔ∏è OBS MIDI Mixer loaded!');
        console.log('üìã Quick Commands:');
        console.log('  debugApp() - Show app status');
        console.log('  testConnections() - Test all connections'); 
        console.log('  scanMIDI() - Scan MIDI devices');
        console.log('  connectOBS() - Connect to OBS');
        console.log('  window.uiManager.runConnectionTest() - Full connection test');
        
        // Launch Control XL specific help
        console.log('\nüéπ Launch Control XL Users:');
        console.log('  1. Aktiviere Low Power Mode (siehe Verbindungen ‚Üí MIDI Hilfe)');
        console.log('  2. Das verhindert automatisches Standby nach 2 Minuten');
        console.log('  3. Bei Problemen: USB neu einstecken');
        
        // Auto-start connection test after initialization
        setTimeout(() => {
            if (window.uiManager && window.uiManager.runConnectionTest) {
                console.log('üöÄ Running auto connection test...');
                window.uiManager.runConnectionTest();
            }
        }, 3000);

        // Performance monitoring
        let loadTime = performance.now();
        window.addEventListener('load', () => {
            const totalLoadTime = performance.now() - loadTime;
            console.log(`‚ö° App loaded in ${totalLoadTime.toFixed(2)}ms`);
            
            // Check for potential issues
            if (totalLoadTime > 5000) {
                console.warn('‚ö†Ô∏è Slow loading detected - check your system performance');
            }
        });

        // Launch Control XL connection monitor
        setTimeout(() => {
            if (window.midiController) {
                const devices = window.midiController.getConnectedDevices();
                const launchControl = devices.find(d => d.name.toLowerCase().includes('launch control'));
                
                if (launchControl) {
                    console.log('üéõÔ∏è Launch Control XL detected!');
                    console.log('üí° Tip: Aktiviere Low Power Mode f√ºr bessere Stabilit√§t');
                    
                    // Show helpful notification
                    setTimeout(() => {
                        if (window.uiManager && window.uiManager.showSuccessMessage) {
                            window.uiManager.showSuccessMessage('Launch Control XL erkannt! Aktiviere Low Power Mode f√ºr bessere Stabilit√§t.');
                        }
                    }, 5000);
                }
            }
        }, 4000);
    </script>
</body>
</html>