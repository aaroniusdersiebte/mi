<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS MIDI Mixer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header Bar -->
        <header class="header-bar">
            <div class="header-left">
                <h1 class="app-title">OBS MIDI Mixer</h1>
                <div class="connection-status">
                    <div class="status-indicator" id="obsStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">OBS: Verbindung...</span>
                    </div>
                    <div class="status-indicator" id="midiStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">MIDI: Suche...</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="connectBtn" title="Verbindungen pr√ºfen">üîó</button>
                <button class="header-btn" id="debugBtn" title="Debug-Info">üêõ</button>
                <button class="header-btn" id="settingsBtn" title="Einstellungen">‚öôÔ∏è</button>
                <button class="header-btn" id="minimizeBtn" title="Minimieren">‚àí</button>
                <button class="header-btn close" id="closeBtn" title="Schlie√üen">√ó</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Audio Section (Left) -->
            <section class="audio-section" id="audioSection">
                <div class="section-header">
                    <h2>Audio Quellen</h2>
                    <button class="refresh-btn" id="refreshAudio">üîÑ</button>
                </div>
                
                <div class="audio-sources" id="audioSources">
                    <!-- Audio sources will be dynamically loaded here -->
                    <div class="no-sources-message" id="noSourcesMessage">
                        <p>Keine Audio-Quellen gefunden</p>
                        <p class="help-text">Verbinde dich mit OBS und stelle sicher, dass Audio-Quellen vorhanden sind</p>
                    </div>
                </div>
            </section>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resizeHandle">
                <div class="resize-line"></div>
            </div>

            <!-- Hotkeys Section (Right) -->
            <section class="hotkeys-section" id="hotkeysSection">
                <div class="section-header">
                    <h2>MIDI Hotkeys</h2>
                    <div class="hotkey-buttons">
                        <button class="learn-btn" id="learnMidiBtn">MIDI Lernen</button>
                        <button class="test-btn" id="testBtn">üß™ Test</button>
                    </div>
                </div>
                
                <div class="hotkey-mappings" id="hotkeyMappings">
                    <div class="no-mappings-message" id="noMappingsMessage">
                        <p>Keine MIDI-Zuordnungen</p>
                        <p class="help-text">Dr√ºcke "MIDI Lernen" und bet√§tige dein MIDI-Ger√§t</p>
                        <p class="help-text">Oder ordne Audio-Quellen und Szenen direkt zu</p>
                    </div>
                    
                    <!-- Scene mappings will be added here dynamically -->
                </div>
            </section>
        </main>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Einstellungen</h3>
                    <button class="modal-close" id="closeSettings">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="settings-group">
                        <label>OBS WebSocket URL:</label>
                        <input type="text" id="obsUrl" placeholder="ws://localhost:4455">
                    </div>
                    <div class="settings-group">
                        <label>OBS Passwort:</label>
                        <input type="password" id="obsPassword" placeholder="Passwort (optional)">
                    </div>
                    <div class="settings-group">
                        <label>MIDI Ger√§t:</label>
                        <select id="midiDevice">
                            <option value="">Automatisch erkennen</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="resetSettings">Zur√ºcksetzen</button>
                    <button class="btn-primary" id="saveSettings">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Connection Modal -->
        <div class="modal-overlay" id="connectionModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Verbindungsstatus</h3>
                    <button class="modal-close" id="closeConnection">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="connection-section">
                        <h4>OBS Studio</h4>
                        <div class="connection-info" id="obsConnectionInfo">
                            <p>Status: <span id="obsConnectionStatus">Pr√ºfe...</span></p>
                            <p>URL: <span id="obsConnectionUrl">ws://localhost:4455</span></p>
                            <p>Versuche: <span id="obsReconnectAttempts">0</span></p>
                        </div>
                        <button class="btn-primary" id="connectObs">OBS Verbinden</button>
                        <button class="btn-secondary" id="disconnectObs">Trennen</button>
                    </div>
                    
                    <div class="connection-section">
                        <h4>MIDI Controller</h4>
                        <div class="connection-info" id="midiConnectionInfo">
                            <p>Status: <span id="midiConnectionStatus">Pr√ºfe...</span></p>
                            <p>Ger√§t: <span id="midiDeviceName">Kein Ger√§t</span></p>
                            <p>Verf√ºgbare Ger√§te: <span id="midiDeviceCount">0</span></p>
                        </div>
                        <button class="btn-primary" id="scanMidi">MIDI Scannen</button>
                        <button class="btn-secondary" id="disconnectMidi">Trennen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="refreshConnection">Aktualisieren</button>
                </div>
            </div>
        </div>

        <!-- Debug Modal -->
        <div class="modal-overlay" id="debugModal" style="display: none;">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>Debug-Information</h3>
                    <button class="modal-close" id="closeDebug">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="debug-section">
                        <h4>App Status</h4>
                        <pre id="debugAppStatus">Lade...</pre>
                    </div>
                    <div class="debug-section">
                        <h4>MIDI Events (Live)</h4>
                        <div class="debug-log" id="midiEventLog">Keine Events...</div>
                        <button class="btn-secondary" id="clearMidiLog">Log l√∂schen</button>
                    </div>
                    <div class="debug-section">
                        <h4>OBS Events (Live)</h4>
                        <div class="debug-log" id="obsEventLog">Keine Events...</div>
                        <button class="btn-secondary" id="clearObsLog">Log l√∂schen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="exportDebug">Debug exportieren</button>
                    <button class="btn-primary" id="refreshDebug">Aktualisieren</button>
                </div>
            </div>
        </div>

        <!-- MIDI Learning Overlay -->
        <div class="midi-learning-overlay" id="midiLearningOverlay" style="display: none;">
            <div class="learning-content">
                <div class="learning-icon">üéπ</div>
                <h3>MIDI Learning Aktiv</h3>
                <p>Bewege einen Regler oder dr√ºcke einen Button auf deinem MIDI-Controller</p>
                <div class="learning-target" id="learningTarget"></div>
                <button class="btn-secondary" onclick="window.uiManager.stopMidiLearning()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Scripts - Load in correct order for proper initialization -->
    <script>
        console.log('Starting module initialization...');
        
        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Global JavaScript Error:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled Promise Rejection:', event.reason);
        });
    </script>
    
    <!-- Load managers in dependency order -->
    <script src="../modules/settings-manager.js"></script>
    <script src="../modules/obs-websocket.js"></script>
    <script src="../modules/midi-controller.js"></script>
    <script src="../modules/audio-manager.js"></script>
    <script src="../modules/ui-manager.js"></script>
    
    <!-- Load main renderer -->
    <script src="renderer.js"></script>
    
    <script>
        // Module loading verification
        console.log('=== Module Loading Status ===');
        console.log('Settings Manager:', typeof window.settingsManager);
        console.log('OBS Manager:', typeof window.obsManager);
        console.log('MIDI Controller:', typeof window.midiController);
        console.log('Audio Manager:', typeof window.audioManager);
        console.log('UI Manager:', typeof window.uiManager);
        
        // Web API availability check
        console.log('Web MIDI API:', typeof navigator.requestMIDIAccess);
        console.log('WebSocket API:', typeof WebSocket);
        console.log('LocalStorage API:', typeof localStorage);
        
        // Quick start helper
        console.log('\nüéõÔ∏è OBS MIDI Mixer loaded!');
        console.log('üìã Quick Commands:');
        console.log('  debugApp() - Show app status');
        console.log('  testConnections() - Test all connections'); 
        console.log('  scanMIDI() - Scan MIDI devices');
        console.log('  connectOBS() - Connect to OBS');
        
        // Auto-start connection test after initialization
        setTimeout(() => {
            if (window.uiManager && window.uiManager.runConnectionTest) {
                console.log('üöÄ Running auto connection test...');
                window.uiManager.runConnectionTest();
            }
        }, 3000);
    </script>
</body>
</html>